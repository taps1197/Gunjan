var Ingest=function(e){function t(s){if(n[s])return n[s].exports;var i=n[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,s){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:s})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,n){"use strict";(function(t){function n(e,t){var n=e.toString();if(n.length<t){var s=[];s.length=t-n.length+1,n=s.join("0")+n}return n}function s(e,t){return Object.getOwnPropertyNames(t).forEach(function(n){if("object"==typeof t[n])"object"!=typeof e[n]&&(e[n]={}),s(e[n],t[n]);else{var i=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,i)}}),e}function i(e,t,n){e.forEach(function(e){setTimeout(function(){e(t,n)})})}function o(e,t){var n=this;e=e||{},t=t||{};var i=function(e){throw n._log(e),new Error("ERROR: "+e)};this._queuedEvents=[],this._queuedCallbacks=[],this._lastSendTime=0,this._isEnabled=!1,this._dependencies=s({},e),e.getAccessToken&&"function"==typeof e.getAccessToken||i("Missing dependency: getAccessToken"),this._options={},Object.keys(a).forEach(function(e){this._options[e]=t[e]||a[e]},this),u.forEach(function(e){this._options[e]||i("Missing option: "+e)},this)}var r={prod:"cc-api-data.adobe.io",stage:"cc-api-data-stage.adobe.io",dev:"cc-api-data-dev.adobe.io"},a={ENVIRONMENT:"prod",ALLOW_NO_TOKEN:!1,ANALYTICS_INGEST_TYPE:"dunamis",ANALYTICS_MAX_QUEUED_EVENTS:50,ANALYTICS_DEBOUNCE:1e4,ANALYTICS_API_KEY:null,ANALYTICS_X_PRODUCT:null,ANALYTICS_X_PRODUCT_LOCATION:void 0,ANALYTICS_PROJECT:null,ANALYTICS_USER_REGION:"UNKNOWN",TIMESTAMP_PROPERTY_NAME:"event.dts_end"},u=["ANALYTICS_API_KEY","ANALYTICS_X_PRODUCT","ANALYTICS_PROJECT"];o.prototype._log=function(e){var t=this._dependencies.log;t&&t("Ingest :: "+e)},o.prototype._getAgent=function(e,t){this._dependencies.getAgent?this._dependencies.getAgent(e,t):t(null,{})},o.prototype._getAccessToken=function(e){this._dependencies.getAccessToken(e)},o.prototype._clearAccessToken=function(){this._dependencies.clearAccessToken&&this._dependencies.clearAccessToken()},o.prototype._getEnvironment=function(){return r[this._options.ENVIRONMENT]?this._options.ENVIRONMENT:"prod"},o.prototype._getAnalyticsHost=function(){return r[this._getEnvironment()]},o.prototype._formatTimestamp=function(e){var t=e.getFullYear(),s=n(e.getMonth()+1,2),i=n(e.getDate(),2),o=n(e.getHours(),2),r=n(e.getMinutes(),2),a=n(e.getSeconds(),2),u=n(e.getMilliseconds(),3),_=e.getTimezoneOffset(),c=_<0?"+":"-",d=Math.floor(Math.abs(_)/60),l=Math.abs(_)%60;return t+"-"+s+"-"+i+"T"+o+":"+r+":"+a+"."+u+(c+n(d,2)+n(l,2))},o.prototype._updateDebounce=function(e){var t=e&&(e["retry-after"]||e["Retry-After"]),n=0;if(t){var s;try{s=parseInt(t,10)}catch(e){}if(s)n=Math.max(0,s);else{var i=Date.parse(t);if(i){var o=(new Date).valueOf();n=Math.max(0,i-o)/1e3+Math.floor(10*Math.random())}}}this._options.ANALYTICS_DEBOUNCE=Math.max(1e3*n,this._options.ANALYTICS_DEBOUNCE)},o.prototype._queueEvent=function(e){this._queuedEvents.length>=this._options.ANALYTICS_MAX_QUEUED_EVENTS&&this._queuedEvents.shift(),this._queuedEvents.push(e)},o.prototype._requeueEvents=function(e){this._queuedEvents=e.concat(this._queuedEvents),this._queuedEvents=function(e,t){var n=e;if(e&&e.length>t&&t>0){var s=e.length-t;n=e.slice(s,e.length)}return n}(this._queuedEvents,this._options.ANALYTICS_MAX_QUEUED_EVENTS)},o.prototype._sendAnalytics=function(e,n,o){var r=this;if(o=o||0,n&&this._queuedCallbacks.push(n),!this._isEnabled||0===this._queuedEvents.length){var a=this._queuedCallbacks;return this._queuedCallbacks=[],void(this._isEnabled?i(a,null,0):i(a,new Error("Analytics Disabled")))}var u=this._options.ANALYTICS_DEBOUNCE;if(e&&(u=0,clearTimeout(this._pendingSendAnalyticsTimeout),this._pendingSendAnalyticsTimeout=void 0),this._sendingEvents||this._pendingSendAnalyticsTimeout)this._log("Queued "+this._queuedEvents.length+" events to be sent.");else{var _=(new Date).valueOf();if(_-this._lastSendTime<u)this._pendingSendAnalyticsTimeout=setTimeout(function(){r._pendingSendAnalyticsTimeout=void 0,r._sendAnalytics()},u);else{this._lastSendTime=_,this._sendingEvents=this._queuedEvents,this._sendingCallbacks=this._queuedCallbacks,this._queuedEvents=[],this._queuedCallbacks=[];var c=function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}(),d="["+c+"] ",l={events:this._sendingEvents},p=function(e){var t=r._queuedEvents.length,n=r._sendingEvents.length;e?(r._requeueEvents(r._sendingEvents),r._log(d+"Error sending "+n+" events: "+e)):r._log(d+"Success sending "+n+" events: "+JSON.stringify(r._sendingEvents)),delete r._sendingEvents;var s=r._sendingCallbacks;delete r._sendingCallbacks,e?i(s,e):i(s,null,n),t>0&&r._sendAnalytics()},h=function(e,t){if(r._updateDebounce(t),401===e&&0===o)return r._clearAccessToken(),r._requeueEvents(r._sendingEvents),delete r._sendingEvents,r._queuedCallbacks=r._sendingCallbacks.concat(r._queuedCallbacks),delete r._sendingCallbacks,r._log(d+"Access token is expired. Retry one more time."),void r._sendAnalytics(!0,void 0,o+1);200===e?p():p(new Error("Unexpected Response: "+e))};this._getAccessToken(function(e,n){if(e)p(e);else if(n&&0!==n.length||r._options.ALLOW_NO_TOKEN){var i="https://"+r._getAnalyticsHost();if(r._log(d+"Sending analytics to "+i+"/ingest"),void 0!==t&&t.Buffer){var o={"x-api-key":r._options.ANALYTICS_API_KEY,"X-Product":r._options.ANALYTICS_X_PRODUCT,"X-Request-Id":c,"Content-Type":"application/json"};n&&(o.Authorization="Bearer "+n);var a={hostname:r._getAnalyticsHost(),port:443,path:"/ingest",method:"POST",headers:o};r._options.ANALYTICS_X_PRODUCT_LOCATION&&(a.headers["X-Product-Location"]=r._options.ANALYTICS_X_PRODUCT_LOCATION),r._getAgent(i,function(e,t){t&&t.agent?a.agent=t&&t.agent:s(a,t||{});var n=nodeRequire("https").request(a,function(e){e&&function(e){var t=function(){};e.on("data",t),e.on("end",t)}(e);var t=e&&e.statusCode,n=e&&e.headers;h(t,n)});n.once("error",function(e){p(e)}),n.end(JSON.stringify(l))})}else{!function(e){var t=new XMLHttpRequest;t.onreadystatechange=function(){if(4===this.readyState){var e=t.getAllResponseHeaders();h(this.status,e)}},t.onerror=function(e){p(new Error(e))},t.open("POST",i+"/ingest",!0),t.setRequestHeader("x-api-key",r._options.ANALYTICS_API_KEY),t.setRequestHeader("x-user-region",r._options.ANALYTICS_USER_REGION),t.setRequestHeader("Content-Type","application/json"),n&&t.setRequestHeader("Authorization","Bearer "+n),t.setRequestHeader("X-Product",r._options.ANALYTICS_X_PRODUCT),t.setRequestHeader("X-Product-Location",r._options.ANALYTICS_X_PRODUCT_LOCATION),t.setRequestHeader("X-Request-Id",c),t.send(e)}(JSON.stringify(l))}}else p(new Error("No access token"))})}}},o.prototype.enable=function(e){this._isEnabled=e,e&&this._sendAnalytics(!0)},o.prototype.postEvent=function(e,t){var n=this._formatTimestamp(new Date);e[this._options.TIMESTAMP_PROPERTY_NAME]=n;var s={time:n,project:this._options.ANALYTICS_PROJECT,environment:this._getEnvironment(),ingesttype:this._options.ANALYTICS_INGEST_TYPE,data:e};this._queueEvent(s),this._sendAnalytics(!1,t)},o.prototype.flush=function(e,t){this._sendAnalytics(e,t)},e.exports=o}).call(t,n(1))},function(e,t){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n}]);
//# sourceMappingURL=ingest.min.js.map